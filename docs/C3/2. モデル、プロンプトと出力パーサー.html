<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>2. モデル、プロンプトと出力パーサー</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown-min.css" />
</head>
<body>
<h1 id="第二章-モデルプロンプトと出力パーサー">第二章
モデル、プロンプトと出力パーサー</h1>
<p>本章では、LLM開発に関するいくつかの重要な概念について簡潔に紹介します：モデル、プロンプト、パーサーです。前の二つの部分の内容を完全に学習された方は、これら三つの概念に馴染みがあるでしょう。しかし、LangChainの定義では、これら三つの概念の定義と使用方法は以前とは微妙に異なります。LLM開発をさらに深く理解するために、本章を注意深く読むことをお勧めします。また、この部分を直接学習される場合、本章の内容はより重要な基礎となります。</p>
<p>まず、OpenAIを直接呼び出すシナリオをデモンストレーションし、なぜLangChainを使用する必要があるかを十分に説明します。</p>
<h2 id="一openaiの直接呼び出し">一、OpenAIの直接呼び出し</h2>
<h3 id="の計算">1.1 1+1の計算</h3>
<p>簡単な例を見てみましょう。OpenAIインターフェースでラップされた関数<code>get_completion</code>を直接使用して、モデルに<code>1+1は何ですか？</code>と尋ねてもらいます。</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tool <span class="im">import</span> get_completion</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>get_completion(<span class="st">&quot;1+1是什么？&quot;</span>)</span></code></pre></div>
<pre><code>&#39;1+1等于2。&#39;</code></pre>
<h3 id="海賊メールを標準中国語で表現">1.2
海賊メールを標準中国語で表現</h3>
<p>上記の簡単な例では、モデル<code>gpt-3.5-turbo</code>が1+1が何かについての答えを提供してくれました。そして今、より豊かで複雑なシナリオに入ります。</p>
<p>あなたがEコマース会社の従業員だと想像してください。顧客の中に海賊Aという特別な顧客がいます。彼はあなたのプラットフォームでジューサーを購入し、美味しいスムージーを作ることを目的としていました。しかし製作過程で、何らかの理由でスムージーの蓋が突然飛び開き、キッチンの壁にスムージーが飛び散りました。この海賊の怒りと挫折を想像してみてください。彼は海賊特有の中国語方言で、カスタマーサービスセンターにメール<code>customer_email</code>を書きました。</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>customer_email <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="st">嗯呐，我现在可是火冒三丈，我那个搅拌机盖子竟然飞了出去，把我厨房的墙壁都溅上了果汁！</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="st">更糟糕的是，保修条款可不包括清理我厨房的费用。</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="st">伙计，赶紧给我过来！</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span></code></pre></div>
<p>多文化背景の顧客を扱う際、カスタマーサービスチームは特定の言語障壁に遭遇する可能性があります。上記のように、海賊顧客からのメールを受け取りましたが、彼の表現方法はカスタマーサービスチームにとって少し理解しにくいものでした。</p>
<p>この課題を解決するために、以下の2つの目標を設定しました：</p>
<ul>
<li>まず、海賊方言に満ちたこのメールを標準中国語に翻訳し、カスタマーサービスチームがその内容をより理解しやすくすることを希望します。</li>
<li>次に、翻訳を行う際、モデルが穏やかで敬意のあるトーンを採用することを期待します。これにより情報の正確な伝達を確保するだけでなく、顧客との調和のとれた関係を維持できます。</li>
</ul>
<p>モデルの出力を導くために、テキスト表現スタイルタグを定義し、これを<code>style</code>と略します。</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 普通话 + 平静、尊敬的语调</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>style <span class="op">=</span> <span class="st">&quot;&quot;&quot;正式普通话 </span><span class="ch">\</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="st">用一个平静、尊敬、有礼貌的语调</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span></code></pre></div>
<p>次に行う必要があるのは、<code>customer_email</code>と<code>style</code>を組み合わせてプロンプト<code>prompt</code>を構築することです。</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 要求模型根据给出的语调进行转化</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> <span class="ss">f&quot;&quot;&quot;把由三个反引号分隔的文本</span><span class="ch">\</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="ss">翻译成一种</span><span class="sc">{</span>style<span class="sc">}</span><span class="ss">风格。</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="ss">文本: ```</span><span class="sc">{</span>customer_email<span class="sc">}</span><span class="ss">```</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="ss">&quot;&quot;&quot;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;提示：&quot;</span>, prompt)</span></code></pre></div>
<pre><code>提示： 
 把由三个反引号分隔的文本翻译成一种正式普通话 用一个平静、尊敬、有礼貌的语调
风格。
文本: ```
嗯呐，我现在可是火冒三丈，我那个搅拌机盖子竟然飞了出去，把我厨房的墙壁都溅上了果汁！
更糟糕的是，保修条款可不包括清理我厨房的费用。
伙计，赶紧给我过来！
```</code></pre>
<p>精心設計された<code>prompt</code>の準備が完了しました。次に、<code>get_completion</code>メソッドを呼び出すだけで、期待される出力を得ることができます——その本格的な海賊方言のメールが、穏やかで敬意のある正式な標準中国語表現に翻訳されます。</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> get_completion(prompt)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(response)</span></code></pre></div>
<pre><code>非常抱歉，我现在感到非常愤怒和不满。我的搅拌机盖子竟然飞了出去，导致我厨房的墙壁上都溅满了果汁！更糟糕的是，保修条款并不包括清理我厨房的费用。先生/女士，请您尽快过来处理这个问题！</code></pre>
<p>言語スタイル変換を行った後、明らかな変化を観察できます：元の用語がより正式になり、極端な感情を含む表現が置き換えられ、さらにテキストに感謝を表す語彙が加えられました。</p>
<blockquote>
<p>小さなアドバイス：異なるプロンプトを調整して試すことで、モデルがどのような革新的な出力をもたらすかを探索できます。毎回の試行が予想外の驚きをもたらす可能性があります！</p>
</blockquote>
<h2
id="二langchainを通じたopenaiの使用">二、LangChainを通じたOpenAIの使用</h2>
<p>前のセクションでは、ラップされた関数<code>get_completion</code>を使用し、OpenAIインターフェースを利用してその方言に満ちたメールの翻訳に成功しました。穏やかで敬意のあるトーンを採用し、標準中国語で書かれたメールを得ました。次に、LangChainを使用してこの問題を解決してみます。</p>
<h3 id="モデル">2.1 モデル</h3>
<p>今度はLangChainを使用して同じ機能を実現してみましょう。<code>langchain.chat_models</code>から<code>OpenAI</code>の対話モデル<code>ChatOpenAI</code>をインポートします。OpenAI以外にも、<code>langchain.chat_models</code>は他の対話モデルも統合しており、詳細は<a
href="https://python.langchain.com/en/latest/modules/models/chat/integrations.html">Langchain公式ドキュメント</a>で確認できます。</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.chat_models <span class="im">import</span> ChatOpenAI</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 这里我们将参数temperature设置为0.0，从而减少生成答案的随机性。</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 如果你想要每次得到不一样的有新意的答案，可以尝试调整该参数。</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> ChatOpenAI(temperature<span class="op">=</span><span class="fl">0.0</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>chat</span></code></pre></div>
<pre><code>ChatOpenAI(cache=None, verbose=False, callbacks=None, callback_manager=None, tags=None, metadata=None, client=&lt;class &#39;openai.api_resources.chat_completion.ChatCompletion&#39;&gt;, model_name=&#39;gpt-3.5-turbo&#39;, temperature=0.0, model_kwargs={}, openai_api_key=&#39;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&#39;, openai_api_base=&#39;&#39;, openai_organization=&#39;&#39;, openai_proxy=&#39;&#39;, request_timeout=None, max_retries=6, streaming=False, n=1, max_tokens=None, tiktoken_model_name=None)</code></pre>
<p><br></p>
<p>上記の出力は、ChatOpenAIのデフォルトモデルが<code>gpt-3.5-turbo</code>であることを示しています。</p>
<h3 id="プロンプトテンプレートの使用">2.2
プロンプトテンプレートの使用</h3>
<p>前の例では、<a
href="https://docs.python.org/zh-cn/3/tutorial/inputoutput.html#tut-f-strings">f文字列</a>を通じてPython式の値<code>style</code>と<code>customer_email</code>を<code>prompt</code>文字列内に追加しました。</p>
<p><code>langchain</code>は、プロンプトを便利かつ迅速に構築し使用するためのインターフェースを提供しています。</p>
<h4 id="標準中国語で海賊メールを表現">2.2.1
標準中国語で海賊メールを表現</h4>
<p>それでは、<code>langchain</code>を使用してプロンプトを構築する方法を見てみましょう！</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.prompts <span class="im">import</span> ChatPromptTemplate</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 首先，构造一个提示模版字符串：`template_string`</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>template_string <span class="op">=</span> <span class="st">&quot;&quot;&quot;把由三个反引号分隔的文本</span><span class="ch">\</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="st">翻译成一种</span><span class="sc">{style}</span><span class="st">风格。</span><span class="ch">\</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="st">文本: ```</span><span class="sc">{text}</span><span class="st">```</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 然后，我们调用`ChatPromptTemplatee.from_template()`函数将</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 上面的提示模版字符`template_string`转换为提示模版`prompt_template`</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>prompt_template <span class="op">=</span> ChatPromptTemplate.from_template(template_string)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>, prompt_template.messages[<span class="dv">0</span>].prompt)</span></code></pre></div>
<pre><code> input_variables=[&#39;style&#39;, &#39;text&#39;] output_parser=None partial_variables={} template=&#39;把由三个反引号分隔的文本翻译成一种{style}风格。文本: ```{text}```\n&#39; template_format=&#39;f-string&#39; validate_template=True</code></pre>
<p><br></p>
<p>与えられた<code>customer_style</code>と<code>customer_email</code>に対して、プロンプトテンプレート<code>prompt_template</code>の<code>format_messages</code>メソッドを使用して、望ましい顧客メッセージ<code>customer_messages</code>を生成できます。</p>
<p>プロンプトテンプレート<code>prompt_template</code>は2つの入力変数を必要とします：<code>style</code>と<code>text</code>。これらはそれぞれ以下に対応します：
- <code>customer_style</code>：望ましい顧客メールスタイル -
<code>customer_email</code>：顧客の元のメールテキスト。</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>customer_style <span class="op">=</span> <span class="st">&quot;&quot;&quot;正式普通话 </span><span class="ch">\</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="st">用一个平静、尊敬的语气</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>customer_email <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="st">嗯呐，我现在可是火冒三丈，我那个搅拌机盖子竟然飞了出去，把我厨房的墙壁都溅上了果汁！</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="st">更糟糕的是，保修条款可不包括清理我厨房的费用。</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="st">伙计，赶紧给我过来！</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用提示模版</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>customer_messages <span class="op">=</span> prompt_template.format_messages(</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>                    style<span class="op">=</span>customer_style,</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>                    text<span class="op">=</span>customer_email)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 打印客户消息类型</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;客户消息类型:&quot;</span>,<span class="bu">type</span>(customer_messages),<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 打印第一个客户消息类型</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;第一个客户消息的类型:&quot;</span>, <span class="bu">type</span>(customer_messages[<span class="dv">0</span>]),<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 打印第一个元素</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;第一个客户消息: &quot;</span>, customer_messages[<span class="dv">0</span>],<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>客户消息类型:
 &lt;class &#39;list&#39;&gt; 

第一个客户消息的类型:
 &lt;class &#39;langchain.schema.messages.HumanMessage&#39;&gt; 

第一个客户消息: 
 content=&#39;把由三个反引号分隔的文本翻译成一种正式普通话 用一个平静、尊敬的语气\n风格。文本: ```\n嗯呐，我现在可是火冒三丈，我那个搅拌机盖子竟然飞了出去，把我厨房的墙壁都溅上了果汁！\n更糟糕的是，保修条款可不包括清理我厨房的费用。\n伙计，赶紧给我过来！\n```\n&#39; additional_kwargs={} example=False </code></pre>
<p><br></p>
<p>以下のことがわかります： -
<code>customer_messages</code>変数タイプはリスト（<code>list</code>） -
リスト内の要素変数タイプはlangchainカスタムメッセージ（<code>langchain.schema.HumanMessage</code>）。</p>
<p><br></p>
<p>今度はモデル部分で定義された<code>chat</code>モデルを呼び出して、顧客メッセージスタイルの変換を実現できます。</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>customer_response <span class="op">=</span> chat(customer_messages)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(customer_response.content)</span></code></pre></div>
<pre><code>非常抱歉，我现在感到非常愤怒。我的搅拌机盖子竟然飞了出去，导致我厨房的墙壁上都溅满了果汁！更糟糕的是，保修条款并不包括清理我厨房的费用。伙计，请你尽快过来帮我解决这个问题！</code></pre>
<h4 id="海賊方言でメールに返信">2.2.2 海賊方言でメールに返信</h4>
<p>これまでで、前の部分のタスクを実現しました。次に、さらに進んで、カスタマーサービス担当者の返信メッセージを海賊スタイル中国語に変換し、メッセージが比較的丁寧であることを確保します。ここでは、前に構築したlangchainプロンプトテンプレートを引き続き使用して、返信メッセージプロンプトを取得できます。</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>service_reply <span class="op">=</span> <span class="st">&quot;&quot;&quot;嘿，顾客， </span><span class="ch">\</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="st">保修不包括厨房的清洁费用， </span><span class="ch">\</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="st">因为您在启动搅拌机之前 </span><span class="ch">\</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="st">忘记盖上盖子而误用搅拌机, </span><span class="ch">\</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="st">这是您的错。 </span><span class="ch">\</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="st">倒霉！ 再见！</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>service_style_pirate <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span><span class="ch">\</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="st">一个有礼貌的语气 </span><span class="ch">\</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="st">使用海盗风格</span><span class="ch">\</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>service_messages <span class="op">=</span> prompt_template.format_messages(</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    style<span class="op">=</span>service_style_pirate,</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    text<span class="op">=</span>service_reply)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>, service_messages[<span class="dv">0</span>].content)</span></code></pre></div>
<pre><code> 把由三个反引号分隔的文本翻译成一种一个有礼貌的语气 使用海盗风格风格。文本: ```嘿，顾客， 保修不包括厨房的清洁费用， 因为您在启动搅拌机之前 忘记盖上盖子而误用搅拌机, 这是您的错。 倒霉！ 再见！
```</code></pre>
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 调用模型部分定义的chat模型来转换回复消息风格</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>service_response <span class="op">=</span> chat(service_messages)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(service_response.content)</span></code></pre></div>
<pre><code>嘿，尊贵的客户啊，保修可不包括厨房的清洁费用，因为您在启动搅拌机之前竟然忘记盖上盖子而误用了搅拌机，这可是您的疏忽之过啊。真是倒霉透顶啊！祝您一路顺风！</code></pre>
<h4 id="プロンプトテンプレートが必要な理由">2.2.3
プロンプトテンプレートが必要な理由</h4>
<p>比較的複雑なシナリオに適用する際、プロンプトは非常に長く、多くの詳細を含む可能性があります。<strong>プロンプトテンプレートを使用することで、設計されたプロンプトをより便利に再利用できます</strong>。英語版プロンプト2.2.3では、課題のプロンプトテンプレート事例を示しています：学生がオンライン学習を行い課題を提出し、プロンプトを通じて学生の提出した課題の採点を実現します。</p>
<p>さらに、LangChainは一部の一般的なシナリオ用のプロンプトテンプレートも提供しています。例えば、自動要約、質問応答、SQLデータベースへの接続、異なるAPIへの接続などです。LangChain内蔵のプロンプトテンプレートを使用することで、時間をかけてプロンプトを設計・構築することなく、独自の大規模モデルアプリケーションを迅速に構築できます。</p>
<p>最後に、大規模モデルアプリケーションを構築する際、通常はモデルの出力が特定の形式になることを期待します。例えば、出力で特定のキーワードを使用して出力を構造化することです。英語版プロンプト2.2.3では、大規模モデルを使用した連鎖思考推論結果の例を示しています
– 質問：<em>What is the elevation range for the area that the eastern
sector of the Colorado orogeny extends into?</em>
に対して、LangChainライブラリ関数を使用して、出力が「Thought」（思考）、「Action」（行動）、「Observation」（観察）を連鎖思考推論のキーワードとして採用し、出力を構造化します。</p>
<h3 id="出力パーサー">2.3 出力パーサー</h3>
<h4 id="出力パーサーを使用しない顧客評価からの情報抽出">2.3.1
出力パーサーを使用しない顧客評価からの情報抽出</h4>
<p>与えられた評価<code>customer_review</code>について、情報を抽出し、以下の形式で出力したいと考えています：</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;gift&quot;</span><span class="fu">:</span> <span class="er">False</span><span class="fu">,</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;delivery_days&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;price_value&quot;</span><span class="fu">:</span> <span class="st">&quot;pretty affordable!&quot;</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.prompts <span class="im">import</span> ChatPromptTemplate</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>customer_review <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span><span class="ch">\</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="st">这款吹叶机非常神奇。 它有四个设置：</span><span class="ch">\</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="st">吹蜡烛、微风、风城、龙卷风。 </span><span class="ch">\</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="st">两天后就到了，正好赶上我妻子的</span><span class="ch">\</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="st">周年纪念礼物。 </span><span class="ch">\</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="st">我想我的妻子会喜欢它到说不出话来。 </span><span class="ch">\</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="st">到目前为止，我是唯一一个使用它的人，而且我一直</span><span class="ch">\</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="st">每隔一天早上用它来清理草坪上的叶子。 </span><span class="ch">\</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="st">它比其他吹叶机稍微贵一点，</span><span class="ch">\</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="st">但我认为它的额外功能是值得的。</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>review_template <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span><span class="ch">\</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="st">对于以下文本，请从中提取以下信息：</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="st">礼物：该商品是作为礼物送给别人的吗？ </span><span class="ch">\</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="st">如果是，则回答 是的；如果否或未知，则回答 不是。</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="st">交货天数：产品需要多少天</span><span class="ch">\</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="st">到达？ 如果没有找到该信息，则输出-1。</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="st">价钱：提取有关价值或价格的任何句子，</span><span class="ch">\</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="st">并将它们输出为逗号分隔的 Python 列表。</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a><span class="st">使用以下键将输出格式化为 JSON：</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a><span class="st">礼物</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a><span class="st">交货天数</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a><span class="st">价钱</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a><span class="st">文本: </span><span class="sc">{text}</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>prompt_template <span class="op">=</span> ChatPromptTemplate.from_template(review_template)</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;提示模版：&quot;</span>, prompt_template)</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>messages <span class="op">=</span> prompt_template.format_messages(text<span class="op">=</span>customer_review)</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> ChatOpenAI(temperature<span class="op">=</span><span class="fl">0.0</span>)</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> chat(messages)</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;结果类型:&quot;</span>, <span class="bu">type</span>(response.content))</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;结果:&quot;</span>, response.content)</span></code></pre></div>
<pre><code>提示模版： 
 input_variables=[&#39;text&#39;] output_parser=None partial_variables={} messages=[HumanMessagePromptTemplate(prompt=PromptTemplate(input_variables=[&#39;text&#39;], output_parser=None, partial_variables={}, template=&#39;对于以下文本，请从中提取以下信息：\n\n礼物：该商品是作为礼物送给别人的吗？ 如果是，则回答 是的；如果否或未知，则回答 不是。\n\n交货天数：产品需要多少天到达？ 如果没有找到该信息，则输出-1。\n\n价钱：提取有关价值或价格的任何句子，并将它们输出为逗号分隔的 Python 列表。\n\n使用以下键将输出格式化为 JSON：\n礼物\n交货天数\n价钱\n\n文本: {text}\n&#39;, template_format=&#39;f-string&#39;, validate_template=True), additional_kwargs={})]

结果类型:
 &lt;class &#39;str&#39;&gt;

结果:
 {
  &quot;礼物&quot;: &quot;是的&quot;,
  &quot;交货天数&quot;: 2,
  &quot;价钱&quot;: [&quot;它比其他吹叶机稍微贵一点&quot;]
}</code></pre>
<p><code>response.content</code>のタイプが文字列（<code>str</code>）であり、辞書（<code>dict</code>）ではないことがわかります。より便利に情報を抽出したい場合は、<code>Langchain</code>の出力パーサーを使用する必要があります。</p>
<h4 id="出力パーサーを使用した顧客評価からの情報抽出">2.3.2
出力パーサーを使用した顧客評価からの情報抽出</h4>
<p>次に、出力パーサーの使用方法を示します。</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>review_template_2 <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span><span class="ch">\</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="st">对于以下文本，请从中提取以下信息：：</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="st">礼物：该商品是作为礼物送给别人的吗？</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="st">如果是，则回答 是的；如果否或未知，则回答 不是。</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="st">交货天数：产品到达需要多少天？ 如果没有找到该信息，则输出-1。</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="st">价钱：提取有关价值或价格的任何句子，并将它们输出为逗号分隔的 Python 列表。</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="st">文本: </span><span class="sc">{text}</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="sc">{format_instructions}</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> ChatPromptTemplate.from_template(template<span class="op">=</span>review_template_2)</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.output_parsers <span class="im">import</span> ResponseSchema</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.output_parsers <span class="im">import</span> StructuredOutputParser</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>gift_schema <span class="op">=</span> ResponseSchema(name<span class="op">=</span><span class="st">&quot;礼物&quot;</span>,</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>                             description<span class="op">=</span><span class="st">&quot;这件物品是作为礼物送给别人的吗？</span><span class="ch">\</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="st">                            如果是，则回答 是的，</span><span class="ch">\</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="st">                            如果否或未知，则回答 不是。&quot;</span>)</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>delivery_days_schema <span class="op">=</span> ResponseSchema(name<span class="op">=</span><span class="st">&quot;交货天数&quot;</span>,</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>                                      description<span class="op">=</span><span class="st">&quot;产品需要多少天才能到达？</span><span class="ch">\</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="st">                                      如果没有找到该信息，则输出-1。&quot;</span>)</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>price_value_schema <span class="op">=</span> ResponseSchema(name<span class="op">=</span><span class="st">&quot;价钱&quot;</span>,</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>                                    description<span class="op">=</span><span class="st">&quot;提取有关价值或价格的任何句子，</span><span class="ch">\</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a><span class="st">                                    并将它们输出为逗号分隔的 Python 列表&quot;</span>)</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>response_schemas <span class="op">=</span> [gift_schema, </span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>                    delivery_days_schema,</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>                    price_value_schema]</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>output_parser <span class="op">=</span> StructuredOutputParser.from_response_schemas(response_schemas)</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>format_instructions <span class="op">=</span> output_parser.get_format_instructions()</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;输出格式规定：&quot;</span>,format_instructions)</span></code></pre></div>
<pre><code>输出格式规定： 
 The output should be a markdown code snippet formatted in the following schema, including the leading and trailing &quot;```json&quot; and &quot;```&quot;:

```json
{
    &quot;礼物&quot;: string  // 这件物品是作为礼物送给别人的吗？                            如果是，则回答 是的，                            如果否或未知，则回答 不是。
    &quot;交货天数&quot;: string  // 产品需要多少天才能到达？                                      如果没有找到该信息，则输出-1。
    &quot;价钱&quot;: string  // 提取有关价值或价格的任何句子，                                    并将它们输出为逗号分隔的 Python 列表
}
```</code></pre>
<div class="sourceCode" id="cb26"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>messages <span class="op">=</span> prompt.format_messages(text<span class="op">=</span>customer_review, format_instructions<span class="op">=</span>format_instructions)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;第一条客户消息:&quot;</span>,messages[<span class="dv">0</span>].content)</span></code></pre></div>
<pre><code>第一条客户消息:
 对于以下文本，请从中提取以下信息：：

礼物：该商品是作为礼物送给别人的吗？
如果是，则回答 是的；如果否或未知，则回答 不是。

交货天数：产品到达需要多少天？ 如果没有找到该信息，则输出-1。

价钱：提取有关价值或价格的任何句子，并将它们输出为逗号分隔的 Python 列表。

文本: 这款吹叶机非常神奇。 它有四个设置：吹蜡烛、微风、风城、龙卷风。 两天后就到了，正好赶上我妻子的周年纪念礼物。 我想我的妻子会喜欢它到说不出话来。 到目前为止，我是唯一一个使用它的人，而且我一直每隔一天早上用它来清理草坪上的叶子。 它比其他吹叶机稍微贵一点，但我认为它的额外功能是值得的。


The output should be a markdown code snippet formatted in the following schema, including the leading and trailing &quot;```json&quot; and &quot;```&quot;:

```json
{
    &quot;礼物&quot;: string  // 这件物品是作为礼物送给别人的吗？                            如果是，则回答 是的，                            如果否或未知，则回答 不是。
    &quot;交货天数&quot;: string  // 产品需要多少天才能到达？                                      如果没有找到该信息，则输出-1。
    &quot;价钱&quot;: string  // 提取有关价值或价格的任何句子，                                    并将它们输出为逗号分隔的 Python 列表
}
```</code></pre>
<div class="sourceCode" id="cb28"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> chat(messages)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;结果类型:&quot;</span>, <span class="bu">type</span>(response.content))</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;结果:&quot;</span>, response.content)</span></code></pre></div>
<pre><code>结果类型:
 &lt;class &#39;str&#39;&gt;

结果:
 ```json
{
    &quot;礼物&quot;: &quot;不是&quot;,
    &quot;交货天数&quot;: &quot;两天后就到了&quot;,
    &quot;价钱&quot;: &quot;它比其他吹叶机稍微贵一点&quot;
}
```</code></pre>
<div class="sourceCode" id="cb30"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>output_dict <span class="op">=</span> output_parser.parse(response.content)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;解析后的结果类型:&quot;</span>, <span class="bu">type</span>(output_dict))</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;解析后的结果:&quot;</span>, output_dict)</span></code></pre></div>
<pre><code>解析后的结果类型:
 &lt;class &#39;dict&#39;&gt;

解析后的结果:
 {&#39;礼物&#39;: &#39;不是&#39;, &#39;交货天数&#39;: &#39;两天后就到了&#39;, &#39;价钱&#39;: &#39;它比其他吹叶机稍微贵一点&#39;}</code></pre>
<p><code>output_dict</code>のタイプは辞書（<code>dict</code>）で、直接<code>get</code>メソッドを使用できます。このような出力は、下流タスクの処理により便利です。</p>
<h2 id="三英語版プロンプト">三、英語版プロンプト</h2>
<p><strong>1.2 海賊メールをアメリカ英語で表現</strong></p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>customer_email <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="st">Arrr, I be fuming that me blender lid </span><span class="ch">\</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="st">flew off and splattered me kitchen walls </span><span class="ch">\</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="st">with smoothie! And to make matters worse,</span><span class="ch">\</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="st">the warranty don&#39;t cover the cost of </span><span class="ch">\</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="st">cleaning up me kitchen. I need yer help </span><span class="ch">\</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="st">right now, matey!</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 美式英语 + 平静、尊敬的语调</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>style <span class="op">=</span> <span class="st">&quot;&quot;&quot;American English </span><span class="ch">\</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="st">in a calm and respectful tone</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 要求模型根据给出的语调进行转化</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> <span class="ss">f&quot;&quot;&quot;Translate the text </span><span class="ch">\</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="ss">that is delimited by triple backticks </span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="ss">into a style that is </span><span class="sc">{</span>style<span class="sc">}</span><span class="ss">.</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="ss">text: ```</span><span class="sc">{</span>customer_email<span class="sc">}</span><span class="ss">```</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="ss">&quot;&quot;&quot;</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;提示：&quot;</span>, prompt)</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> get_completion(prompt)</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;美式英语表达的海盗邮件: &quot;</span>, response)</span></code></pre></div>
<pre><code>提示： 
 Translate the text that is delimited by triple backticks 
into a style that is American English in a calm and respectful tone
.
text: ```
Arrr, I be fuming that me blender lid flew off and splattered me kitchen walls with smoothie! And to make matters worse,the warranty don&#39;t cover the cost of cleaning up me kitchen. I need yer help right now, matey!
```


美式英语表达的海盗邮件:  
 I am quite frustrated that my blender lid flew off and made a mess of my kitchen walls with smoothie! To add to my frustration, the warranty does not cover the cost of cleaning up my kitchen. I kindly request your assistance at this moment, my friend.</code></pre>
<p><strong>2.2.1 標準アメリカ英語で海賊メールを表現</strong></p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.prompts <span class="im">import</span> ChatPromptTemplate</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>template_string <span class="op">=</span> <span class="st">&quot;&quot;&quot;Translate the text </span><span class="ch">\</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="st">that is delimited by triple backticks </span><span class="ch">\</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="st">into a style that is </span><span class="sc">{style}</span><span class="st">. </span><span class="ch">\</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="st">text: ```</span><span class="sc">{text}</span><span class="st">```</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>prompt_template <span class="op">=</span> ChatPromptTemplate.from_template(template_string)</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;提示模版中的第一个提示：&quot;</span>, prompt_template.messages[<span class="dv">0</span>].prompt)</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>customer_style <span class="op">=</span> <span class="st">&quot;&quot;&quot;American English </span><span class="ch">\</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a><span class="st">in a calm and respectful tone</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>customer_email <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a><span class="st">Arrr, I be fuming that me blender lid </span><span class="ch">\</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a><span class="st">flew off and splattered me kitchen walls </span><span class="ch">\</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a><span class="st">with smoothie! And to make matters worse, </span><span class="ch">\</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a><span class="st">the warranty don&#39;t cover the cost of </span><span class="ch">\</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a><span class="st">cleaning up me kitchen. I need yer help </span><span class="ch">\</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a><span class="st">right now, matey!</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>customer_messages <span class="op">=</span> prompt_template.format_messages(</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>                    style<span class="op">=</span>customer_style,</span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>                    text<span class="op">=</span>customer_email)</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;用提示模版中生成的第一条客户消息：&quot;</span>, customer_messages[<span class="dv">0</span>])</span></code></pre></div>
<pre><code>提示模版中的第一个提示： 
 input_variables=[&#39;style&#39;, &#39;text&#39;] output_parser=None partial_variables={} template=&#39;Translate the text that is delimited by triple backticks into a style that is {style}. text: ```{text}```\n&#39; template_format=&#39;f-string&#39; validate_template=True

用提示模版中生成的第一条客户消息： 
 content=&quot;Translate the text that is delimited by triple backticks into a style that is American English in a calm and respectful tone\n. text: ```\nArrr, I be fuming that me blender lid flew off and splattered me kitchen walls with smoothie! And to make matters worse, the warranty don&#39;t cover the cost of cleaning up me kitchen. I need yer help right now, matey!\n```\n&quot; additional_kwargs={} example=False</code></pre>
<p><strong>2.2.2 海賊方言でメールに返信</strong></p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>service_reply <span class="op">=</span> <span class="st">&quot;&quot;&quot;Hey there customer, </span><span class="ch">\</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="st">the warranty does not cover </span><span class="ch">\</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="st">cleaning expenses for your kitchen </span><span class="ch">\</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="st">because it&#39;s your fault that </span><span class="ch">\</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="st">you misused your blender </span><span class="ch">\</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="st">by forgetting to put the lid on before </span><span class="ch">\</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="st">starting the blender. </span><span class="ch">\</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="st">Tough luck! See ya!</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>service_style_pirate <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span><span class="ch">\</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="st">a polite tone </span><span class="ch">\</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="st">that speaks in English Pirate</span><span class="ch">\</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>service_messages <span class="op">=</span> prompt_template.format_messages(</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    style<span class="op">=</span>service_style_pirate,</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    text<span class="op">=</span>service_reply)</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;提示模版中的第一条客户消息内容：&quot;</span>, service_messages[<span class="dv">0</span>].content)</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>service_response <span class="op">=</span> chat(service_messages)</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;模型得到的回复邮件：&quot;</span>, service_response.content)</span></code></pre></div>
<pre><code>提示模版中的第一条客户消息内容： 
 Translate the text that is delimited by triple backticks into a style that is a polite tone that speaks in English Pirate. text: ```Hey there customer, the warranty does not cover cleaning expenses for your kitchen because it&#39;s your fault that you misused your blender by forgetting to put the lid on before starting the blender. Tough luck! See ya!
```


模型得到的回复内容： 
 Ahoy there, matey! I regret to inform ye that the warranty be not coverin&#39; the costs o&#39; cleanin&#39; yer galley, as &#39;tis yer own fault fer misusin&#39; yer blender by forgettin&#39; to secure the lid afore startin&#39; it. Aye, tough luck, me heartie! Fare thee well!</code></pre>
<p><strong>2.3.1
出力パーサーを使用しない顧客評価からの情報抽出</strong></p>
<div class="sourceCode" id="cb38"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>customer_review <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span><span class="ch">\</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="st">This leaf blower is pretty amazing.  It has four settings:</span><span class="ch">\</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="st">candle blower, gentle breeze, windy city, and tornado. </span><span class="ch">\</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="st">It arrived in two days, just in time for my wife&#39;s </span><span class="ch">\</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="st">anniversary present. </span><span class="ch">\</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="st">I think my wife liked it so much she was speechless. </span><span class="ch">\</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="st">So far I&#39;ve been the only one using it, and I&#39;ve been </span><span class="ch">\</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="st">using it every other morning to clear the leaves on our lawn. </span><span class="ch">\</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="st">It&#39;s slightly more expensive than the other leaf blowers </span><span class="ch">\</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="st">out there, but I think it&#39;s worth it for the extra features.</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>review_template <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span><span class="ch">\</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="st">For the following text, extract the following information:</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="st">gift: Was the item purchased as a gift for someone else? </span><span class="ch">\</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a><span class="st">Answer True if yes, False if not or unknown.</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a><span class="st">delivery_days: How many days did it take for the product </span><span class="ch">\</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a><span class="st">to arrive? If this information is not found, output -1.</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a><span class="st">price_value: Extract any sentences about the value or price,</span><span class="ch">\</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a><span class="st">and output them as a comma separated Python list.</span></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a><span class="st">Format the output as JSON with the following keys:</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a><span class="st">gift</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a><span class="st">delivery_days</span></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a><span class="st">price_value</span></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a><span class="st">text: </span><span class="sc">{text}</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.prompts <span class="im">import</span> ChatPromptTemplate</span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>prompt_template <span class="op">=</span> ChatPromptTemplate.from_template(review_template)</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;提示模版：&quot;</span>,prompt_template)</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>messages <span class="op">=</span> prompt_template.format_messages(text<span class="op">=</span>customer_review)</span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> ChatOpenAI(temperature<span class="op">=</span><span class="fl">0.0</span>)</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> chat(messages)</span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;回复内容：&quot;</span>,response.content)</span></code></pre></div>
<pre><code>提示模版： 
 input_variables=[&#39;text&#39;] output_parser=None partial_variables={} messages=[HumanMessagePromptTemplate(prompt=PromptTemplate(input_variables=[&#39;text&#39;], output_parser=None, partial_variables={}, template=&#39;For the following text, extract the following information:\n\ngift: Was the item purchased as a gift for someone else? Answer True if yes, False if not or unknown.\n\ndelivery_days: How many days did it take for the product to arrive? If this information is not found, output -1.\n\nprice_value: Extract any sentences about the value or price,and output them as a comma separated Python list.\n\nFormat the output as JSON with the following keys:\ngift\ndelivery_days\nprice_value\n\ntext: {text}\n&#39;, template_format=&#39;f-string&#39;, validate_template=True), additional_kwargs={})]

回复内容： 
 {
  &quot;gift&quot;: false,
  &quot;delivery_days&quot;: 2,
  &quot;price_value&quot;: [&quot;It&#39;s slightly more expensive than the other leaf blowers out there, but I think it&#39;s worth it for the extra features.&quot;]
}</code></pre>
<p><strong>2.3.2
出力パーサーを使用した顧客評価からの情報抽出</strong></p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>review_template_2 <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span><span class="ch">\</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="st">For the following text, extract the following information:</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="st">gift: Was the item purchased as a gift for someone else? </span><span class="ch">\</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="st">Answer True if yes, False if not or unknown.</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="st">delivery_days: How many days did it take for the product</span><span class="ch">\</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="st">to arrive? If this information is not found, output -1.</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="st">price_value: Extract any sentences about the value or price,</span><span class="ch">\</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="st">and output them as a comma separated Python list.</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="st">text: </span><span class="sc">{text}</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="sc">{format_instructions}</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> ChatPromptTemplate.from_template(template<span class="op">=</span>review_template_2)</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.output_parsers <span class="im">import</span> ResponseSchema</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.output_parsers <span class="im">import</span> StructuredOutputParser</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>gift_schema <span class="op">=</span> ResponseSchema(name<span class="op">=</span><span class="st">&quot;gift&quot;</span>,</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>                             description<span class="op">=</span><span class="st">&quot;Was the item purchased</span><span class="ch">\</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a><span class="st">                             as a gift for someone else? </span><span class="ch">\</span></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a><span class="st">                             Answer True if yes,</span><span class="ch">\</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a><span class="st">                             False if not or unknown.&quot;</span>)</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>delivery_days_schema <span class="op">=</span> ResponseSchema(name<span class="op">=</span><span class="st">&quot;delivery_days&quot;</span>,</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>                                      description<span class="op">=</span><span class="st">&quot;How many days</span><span class="ch">\</span></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a><span class="st">                                      did it take for the product</span><span class="ch">\</span></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a><span class="st">                                      to arrive? If this </span><span class="ch">\</span></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a><span class="st">                                      information is not found,</span><span class="ch">\</span></span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a><span class="st">                                      output -1.&quot;</span>)</span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>price_value_schema <span class="op">=</span> ResponseSchema(name<span class="op">=</span><span class="st">&quot;price_value&quot;</span>,</span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>                                    description<span class="op">=</span><span class="st">&quot;Extract any</span><span class="ch">\</span></span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a><span class="st">                                    sentences about the value or </span><span class="ch">\</span></span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a><span class="st">                                    price, and output them as a </span><span class="ch">\</span></span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a><span class="st">                                    comma separated Python list.&quot;</span>)</span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>response_schemas <span class="op">=</span> [gift_schema, </span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a>                    delivery_days_schema,</span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a>                    price_value_schema]</span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>output_parser <span class="op">=</span> StructuredOutputParser.from_response_schemas(response_schemas)</span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a>format_instructions <span class="op">=</span> output_parser.get_format_instructions()</span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(format_instructions)</span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a>messages <span class="op">=</span> prompt.format_messages(text<span class="op">=</span>customer_review, format_instructions<span class="op">=</span>format_instructions)</span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;提示消息：&quot;</span>, messages[<span class="dv">0</span>].content)</span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> chat(messages)</span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;回复内容：&quot;</span>,response.content)</span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-57"><a href="#cb40-57" aria-hidden="true" tabindex="-1"></a>output_dict <span class="op">=</span> output_parser.parse(response.content)</span>
<span id="cb40-58"><a href="#cb40-58" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;解析后的结果类型:&quot;</span>, <span class="bu">type</span>(output_dict))</span>
<span id="cb40-59"><a href="#cb40-59" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;解析后的结果:&quot;</span>, output_dict)</span></code></pre></div>
<pre><code>The output should be a markdown code snippet formatted in the following schema, including the leading and trailing &quot;```json&quot; and &quot;```&quot;:

```json
{
    &quot;gift&quot;: string  // Was the item purchased                             as a gift for someone else?                              Answer True if yes,                             False if not or unknown.
    &quot;delivery_days&quot;: string  // How many days                                      did it take for the product                                      to arrive? If this                                       information is not found,                                      output -1.
    &quot;price_value&quot;: string  // Extract any                                    sentences about the value or                                     price, and output them as a                                     comma separated Python list.
}
```

提示消息： 
 For the following text, extract the following information:

gift: Was the item purchased as a gift for someone else? Answer True if yes, False if not or unknown.

delivery_days: How many days did it take for the productto arrive? If this information is not found, output -1.

price_value: Extract any sentences about the value or price,and output them as a comma separated Python list.

text: This leaf blower is pretty amazing.  It has four settings:candle blower, gentle breeze, windy city, and tornado. It arrived in two days, just in time for my wife&#39;s anniversary present. I think my wife liked it so much she was speechless. So far I&#39;ve been the only one using it, and I&#39;ve been using it every other morning to clear the leaves on our lawn. It&#39;s slightly more expensive than the other leaf blowers out there, but I think it&#39;s worth it for the extra features.


The output should be a markdown code snippet formatted in the following schema, including the leading and trailing &quot;```json&quot; and &quot;```&quot;:

```json
{
    &quot;gift&quot;: string  // Was the item purchased                             as a gift for someone else?                              Answer True if yes,                             False if not or unknown.
    &quot;delivery_days&quot;: string  // How many days                                      did it take for the product                                      to arrive? If this                                       information is not found,                                      output -1.
    &quot;price_value&quot;: string  // Extract any                                    sentences about the value or                                     price, and output them as a                                     comma separated Python list.
}
```


回复内容： 
 ```json
{
    &quot;gift&quot;: false,
    &quot;delivery_days&quot;: &quot;2&quot;,
    &quot;price_value&quot;: &quot;It&#39;s slightly more expensive than the other leaf blowers out there, but I think it&#39;s worth it for the extra features.&quot;
}
```

解析后的结果类型:
 &lt;class &#39;dict&#39;&gt;

解析后的结果:
 {&#39;gift&#39;: False, &#39;delivery_days&#39;: &#39;2&#39;, &#39;price_value&#39;: &quot;It&#39;s slightly more expensive than the other leaf blowers out there, but I think it&#39;s worth it for the extra features.&quot;}</code></pre>
</body>
</html>
