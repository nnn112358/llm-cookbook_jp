<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>6. 評価</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown-min.css" />
</head>
<body>
<h1 id="第六章-評価">第六章 評価</h1>
<p>評価は言語モデルの質問応答品質を検証する重要な要素です。評価により、言語モデルの異なる文書での質問応答効果を検証し、その弱点を見つけることができます。また、異なるモデルを比較して最適なシステムを選択することも可能です。さらに、定期的な評価によりモデル品質の劣化もチェックできます。評価には通常2つの目的があります：
- LLMアプリケーションが受け入れ基準に達しているかを検証 -
変更がLLMアプリケーションのパフォーマンスに与える影響を分析</p>
<p>基本的な考え方は、言語モデル自体とチェーン自体を利用して、他の言語モデル、チェーン、アプリケーションの評価を支援することです。前章の文書質問応答アプリケーションを例に、本章ではLangChainでの評価の処理と考慮について議論します。</p>
<h2 id="一llmアプリケーションの作成">一、LLMアプリケーションの作成</h2>
<p>まず、langchainチェーンの方式に従ってLLMの文書質問応答アプリケーションを構築します</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.chains <span class="im">import</span> RetrievalQA <span class="co">#检索QA链，在文档上进行检索</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.chat_models <span class="im">import</span> ChatOpenAI <span class="co">#openai模型</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.document_loaders <span class="im">import</span> CSVLoader <span class="co">#文档加载器，采用csv格式存储</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.indexes <span class="im">import</span> VectorstoreIndexCreator <span class="co">#导入向量存储索引创建器</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.vectorstores <span class="im">import</span> DocArrayInMemorySearch <span class="co">#向量存储</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">#加载中文数据</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="bu">file</span> <span class="op">=</span> <span class="st">&#39;../data/product_data.csv&#39;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>loader <span class="op">=</span> CSVLoader(file_path<span class="op">=</span><span class="bu">file</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> loader.load()</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">#查看数据</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>test_data <span class="op">=</span> pd.read_csv(<span class="bu">file</span>,skiprows<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>display(test_data.head())</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
product_name
</th>
<th>
description
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
全自动咖啡机
</td>
<td>
规格:- 尺寸：13.8’’ x 17.3’‘。- 尺寸：11.5’’ …
</td>
</tr>
<tr>
<th>
1
</th>
<td>
电动牙刷
</td>
<td>
规格:- 高度：9.5’‘，宽度：1’’。:…
</td>
</tr>
<tr>
<th>
2
</th>
<td>
橙味维生素C泡腾片
</td>
<td>
规格:20片。:…
</td>
</tr>
<tr>
<th>
3
</th>
<td>
无线蓝牙耳机
</td>
<td>
规格:：1.5’’ x 1.3’’。:…
</td>
</tr>
<tr>
<th>
4
</th>
<td>
瑜伽垫
</td>
<td>
规格:：24’’ x 68’’。:…
</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 将指定向量存储类,创建完成后，我们将从加载器中调用,通过文档记载器列表加载</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>index <span class="op">=</span> VectorstoreIndexCreator(</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    vectorstore_cls<span class="op">=</span>DocArrayInMemorySearch</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>).from_loaders([loader])</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">#通过指定语言模型、链类型、检索器和我们要打印的详细程度来创建检索QA链</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>llm <span class="op">=</span> ChatOpenAI(temperature <span class="op">=</span> <span class="fl">0.0</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>qa <span class="op">=</span> RetrievalQA.from_chain_type(</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    llm<span class="op">=</span>llm, </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    chain_type<span class="op">=</span><span class="st">&quot;stuff&quot;</span>, </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    retriever<span class="op">=</span>index.vectorstore.as_retriever(), </span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    chain_type_kwargs <span class="op">=</span> {</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;document_separator&quot;</span>: <span class="st">&quot;&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;&gt;&quot;</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>上記コードの主要機能と役割については前章で既に説明したため、ここでは詳述しません</p>
<h3 id="テストデータの設定">1.1 テストデータの設定</h3>
<p>文書ローダーCSVLoadによる読み込み後に生成されたdata内の情報を確認してみます。ここではdataの第9条と第10条のデータを抜粋し、その主要内容を見てみましょう：</p>
<p>第10条データ：</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>data[<span class="dv">10</span>]</span></code></pre></div>
<pre><code>Document(page_content=&quot;product_name: 高清电视机\ndescription: 规格:\n尺寸：50&#39;&#39;。\n\n为什么我们热爱它:\n我们的高清电视机拥有出色的画质和强大的音效，带来沉浸式的观看体验。\n\n材质与护理:\n使用干布清洁。\n\n构造:\n由塑料、金属和电子元件制成。\n\n其他特性:\n支持网络连接，可以在线观看视频。\n配备遥控器。\n在韩国制造。\n\n有问题？请随时联系我们的客户服务团队，他们会解答您的所有问题。&quot;, metadata={&#39;source&#39;: &#39;../data/product_data.csv&#39;, &#39;row&#39;: 10})</code></pre>
<p>第11条データ：</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>data[<span class="dv">11</span>]</span></code></pre></div>
<pre><code>Document(page_content=&quot;product_name: 旅行背包\ndescription: 规格:\n尺寸：18&#39;&#39; x 12&#39;&#39; x 6&#39;&#39;。\n\n为什么我们热爱它:\n我们的旅行背包拥有多个实用的内外袋，轻松装下您的必需品，是短途旅行的理想选择。\n\n材质与护理:\n可以手洗，自然晾干。\n\n构造:\n由防水尼龙制成。\n\n其他特性:\n附带可调节背带和安全锁。\n在中国制造。\n\n有问题？请随时联系我们的客户服务团队，他们会解答您的所有问题。&quot;, metadata={&#39;source&#39;: &#39;../data/product_data.csv&#39;, &#39;row&#39;: 11})</code></pre>
<p>上記の第1の文書には高精細テレビ、第2の文書には旅行バックパックが含まれており、これらの詳細から、いくつかの例のクエリと回答を作成できます</p>
<h3 id="テストデータの手動作成">1.2 テストデータの手動作成</h3>
<p>説明すべき点として、ここでは文書がcvファイルなので、文書ローダーとしてCSVLoaderを使用しています。CSVLoaderはcvファイルの各行データを分割するため、ここで見るdata[10]、data[11]の内容はcvファイルの第10条、第11条データの内容となります。以下、この2つのデータに基づいて手動で2つの「質問応答ペア」を設定します。各「質問応答ペア」にはqueryとanswerが含まれます：</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>examples <span class="op">=</span> [</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;query&quot;</span>: <span class="st">&quot;高精細テレビはどのようにケアすればよいですか？&quot;</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;answer&quot;</span>: <span class="st">&quot;乾いた布で清拭してください。&quot;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;query&quot;</span>: <span class="st">&quot;旅行バックパックには内外のポケットがありますか？&quot;</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;answer&quot;</span>: <span class="st">&quot;あります。&quot;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div>
<h3 id="llmによるテストケース生成">1.3 LLMによるテストケース生成</h3>
<p>前述の内容では、すべて手動でテストデータセットを構築する方法を使用していました。例えば、手動で10個の質問〈10個の回答を作成し、LLMにこれら10個の質問に回答させ、LLMの回答と準備した回答を比較し、最後にLLMに採点し評価する、という流れです。しかし、ここには問題があります。すべての質問セットと回答セットを手動で作成する必要があり、これは時間と人的コストを大幅に消費します。大量の質問応答テストセットを自動作成する方法はないでしょうか？もちろんあります。今日はLangchainが提供する方法：<code>QAGenerateChain</code>を紹介します。<code>QAGenerateChain</code>を通じて、文書用の質問応答セットを自動作成できます：</p>
<p><code>QAGenerateChain</code>クラスで使用される<code>PROMPT</code>は英語なので、<code>QAGenerateChain</code>クラスを継承し、<code>PROMPT</code>に「日本語で出力してください」を追加します。以下は<code>generate_chain.py</code>ファイル内の<code>QAGenerateChain</code>クラスのソースコードです</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.evaluation.qa <span class="im">import</span> QAGenerateChain <span class="co">#导入QA生成链，它将接收文档，并从每个文档中创建一个问题答案对</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 下面是langchain.evaluation.qa.generate_prompt中的源码，在template的最后加上“请使用中文输出”</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.output_parsers.regex <span class="im">import</span> RegexParser</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.prompts <span class="im">import</span> PromptTemplate</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.base_language <span class="im">import</span> BaseLanguageModel</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Any</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>template <span class="op">=</span> <span class="st">&quot;&quot;&quot;You are a teacher coming up with questions to ask on a quiz. </span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="st">Given the following document, please generate a question and answer based on that document.</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="st">Example Format:</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Begin Document&gt;</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="st">...</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;End Document&gt;</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="st">QUESTION: question here</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="st">ANSWER: answer here</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="st">These questions should be detailed and be based explicitly on information in the document. Begin!</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Begin Document&gt;</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="sc">{doc}</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;End Document&gt;</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="st">请使用中文输出</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>output_parser <span class="op">=</span> RegexParser(</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    regex<span class="op">=</span><span class="vs">r&quot;QUESTION: (.*?)\nANSWER: (.*)&quot;</span>, output_keys<span class="op">=</span>[<span class="st">&quot;query&quot;</span>, <span class="st">&quot;answer&quot;</span>]</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>PROMPT <span class="op">=</span> PromptTemplate(</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    input_variables<span class="op">=</span>[<span class="st">&quot;doc&quot;</span>], template<span class="op">=</span>template, output_parser<span class="op">=</span>output_parser</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="co"># 继承QAGenerateChain</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ChineseQAGenerateChain(QAGenerateChain):</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;LLM Chain specifically for generating examples for question answering.&quot;&quot;&quot;</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> from_llm(cls, llm: BaseLanguageModel, <span class="op">**</span>kwargs: Any) <span class="op">-&gt;</span> QAGenerateChain:</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Load QA Generate Chain from LLM.&quot;&quot;&quot;</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> cls(llm<span class="op">=</span>llm, prompt<span class="op">=</span>PROMPT, <span class="op">**</span>kwargs)</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>example_gen_chain <span class="op">=</span> ChineseQAGenerateChain.from_llm(ChatOpenAI())<span class="co">#通过传递chat open AI语言模型来创建这个链</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>new_examples <span class="op">=</span> example_gen_chain.<span class="bu">apply</span>([{<span class="st">&quot;doc&quot;</span>: t} <span class="cf">for</span> t <span class="kw">in</span> data[:<span class="dv">5</span>]]) </span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a><span class="co">#查看用例数据</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>new_examples </span></code></pre></div>
<pre><code>[{&#39;qa_pairs&#39;: {&#39;query&#39;: &#39;这款全自动咖啡机的尺寸是多少？&#39;,
   &#39;answer&#39;: &quot;大型尺寸为13.8&#39;&#39; x 17.3&#39;&#39;，中型尺寸为11.5&#39;&#39; x 15.2&#39;&#39;。&quot;}},
 {&#39;qa_pairs&#39;: {&#39;query&#39;: &#39;这款电动牙刷的规格是什么？&#39;, &#39;answer&#39;: &quot;一般大小 - 高度：9.5&#39;&#39;，宽度：1&#39;&#39;。&quot;}},
 {&#39;qa_pairs&#39;: {&#39;query&#39;: &#39;这种产品的名称是什么？&#39;, &#39;answer&#39;: &#39;这种产品的名称是橙味维生素C泡腾片。&#39;}},
 {&#39;qa_pairs&#39;: {&#39;query&#39;: &#39;这款无线蓝牙耳机的尺寸是多少？&#39;,
   &#39;answer&#39;: &quot;该无线蓝牙耳机的尺寸为1.5&#39;&#39; x 1.3&#39;&#39;。&quot;}},
 {&#39;qa_pairs&#39;: {&#39;query&#39;: &#39;这款瑜伽垫的尺寸是多少？&#39;, &#39;answer&#39;: &quot;这款瑜伽垫的尺寸是24&#39;&#39; x 68&#39;&#39;。&quot;}}]</code></pre>
<p>在上面的代码中，我们创建了一个<code>QAGenerateChain</code>，然后我们应用了<code>QAGenerateChain</code>的
apply 方法对 data 中的前5条数据创建了5个“问答对”，由于创建问答集是由 LLM
来自动完成的，因此会涉及到 token
成本的问题，所以我们这里出于演示的目的，只对 data
中的前5条数据创建问答集。</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>new_examples[<span class="dv">0</span>]</span></code></pre></div>
<pre><code>{&#39;qa_pairs&#39;: {&#39;query&#39;: &#39;这款全自动咖啡机的尺寸是多少？&#39;,
  &#39;answer&#39;: &quot;大型尺寸为13.8&#39;&#39; x 17.3&#39;&#39;，中型尺寸为11.5&#39;&#39; x 15.2&#39;&#39;。&quot;}}</code></pre>
<p>源数据：</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>data[<span class="dv">0</span>]</span></code></pre></div>
<pre><code>Document(page_content=&quot;product_name: 全自动咖啡机\ndescription: 规格:\n大型 - 尺寸：13.8&#39;&#39; x 17.3&#39;&#39;。\n中型 - 尺寸：11.5&#39;&#39; x 15.2&#39;&#39;。\n\n为什么我们热爱它:\n这款全自动咖啡机是爱好者的理想选择。 一键操作，即可研磨豆子并沏制出您喜爱的咖啡。它的耐用性和一致性使它成为家庭和办公室的理想选择。\n\n材质与护理:\n清洁时只需轻擦。\n\n构造:\n由高品质不锈钢制成。\n\n其他特性:\n内置研磨器和滤网。\n预设多种咖啡模式。\n在中国制造。\n\n有问题？ 请随时联系我们的客户服务团队，他们会解答您的所有问题。&quot;, metadata={&#39;source&#39;: &#39;../data/product_data.csv&#39;, &#39;row&#39;: 0})</code></pre>
<h3 id="整合测试集">1.4 整合测试集</h3>
<p>还记得我们前面手动创建的两个问答集吗？现在我们需要将之前手动创建的问答集合并到<code>QAGenerateChain</code>创建的问答集中，这样在答集中既有手动创建的例子又有
llm 自动创建的例子，这会使我们的测试集更加完善。</p>
<p>接下来我们就需要让之前创建的文档问答链<code>qa</code>来回答这个测试集里的问题，来看看
LLM 是怎么回答的吧：</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>examples <span class="op">+=</span> [ v <span class="cf">for</span> item <span class="kw">in</span> new_examples <span class="cf">for</span> k,v <span class="kw">in</span> item.items()]</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>qa.run(examples[<span class="dv">0</span>][<span class="st">&quot;query&quot;</span>])</span></code></pre></div>
<pre><code>&gt; Entering new RetrievalQA chain...

&gt; Finished chain.





&#39;高清电视机的护理非常简单。您只需要使用干布清洁即可。避免使用湿布或化学清洁剂，以免损坏电视机的表面。&#39;</code></pre>
<p>这里我们看到<code>qa</code>回答了第0个问题：“高清电视机怎么进行护理？”
，这里的第0个问题就是先前我们手动创建的第一个问题，并且我们手动创建的
answer 是：“使用干布清洁。”
这里我们发现问答链<code>qa</code>回答的也是“您只需要使用干布清洁即可”，只是它比我们的答案还多了一段说明：“高清电视机的护理非常简单。您只需要使用干布清洁即可。避免使用湿布或化学清洁剂，以免损坏电视机的表面。”。</p>
<h2 id="二-人工评估">二、 人工评估</h2>
<p>你想知道<code>qa</code>是怎么找到问题的答案的吗？下面让我们打开<code>debug</code>，看看<code>qa</code>是如何找到问题的答案！</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> langchain</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>langchain.debug <span class="op">=</span> <span class="va">True</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">#重新运行与上面相同的示例，可以看到它开始打印出更多的信息</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>qa.run(examples[<span class="dv">0</span>][<span class="st">&quot;query&quot;</span>])</span></code></pre></div>
<pre><code>[chain/start] [1:chain:RetrievalQA] Entering Chain run with input:
{
  &quot;query&quot;: &quot;高清电视机怎么进行护理？&quot;
}
[chain/start] [1:chain:RetrievalQA &gt; 3:chain:StuffDocumentsChain] Entering Chain run with input:
[inputs]
[chain/start] [1:chain:RetrievalQA &gt; 3:chain:StuffDocumentsChain &gt; 4:chain:LLMChain] Entering Chain run with input:
{
  &quot;question&quot;: &quot;高清电视机怎么进行护理？&quot;,
  &quot;context&quot;: &quot;product_name: 高清电视机\ndescription: 规格:\n尺寸：50&#39;&#39;。\n\n为什么我们热爱它:\n我们的高清电视机拥有出色的画质和强大的音效，带来沉浸式的观看体验。\n\n材质与护理:\n使用干布清洁。\n\n构造:\n由塑料、金属和电子元件制成。\n\n其他特性:\n支持网络连接，可以在线观看视频。\n配备遥控器。\n在韩国制造。\n\n有问题？请随时联系我们的客户服务团队，他们会解答您的所有问题。&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;&gt;product_name: 空气净化器\ndescription: 规格:\n尺寸：15&#39;&#39; x 15&#39;&#39; x 20&#39;&#39;。\n\n为什么我们热爱它:\n我们的空气净化器采用了先进的HEPA过滤技术，能有效去除空气中的微粒和异味，为您提供清新的室内环境。\n\n材质与护理:\n清洁时使用干布擦拭。\n\n构造:\n由塑料和电子元件制成。\n\n其他特性:\n三档风速，附带定时功能。\n在德国制造。\n\n有问题？请随时联系我们的客户服务团队，他们会解答您的所有问题。&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;&gt;product_name: 宠物自动喂食器\ndescription: 规格:\n尺寸：14&#39;&#39; x 9&#39;&#39; x 15&#39;&#39;。\n\n为什么我们热爱它:\n我们的宠物自动喂食器可以定时定量投放食物，让您无论在家或外出都能确保宠物的饮食。\n\n材质与护理:\n可用湿布清洁。\n\n构造:\n由塑料和电子元件制成。\n\n其他特性:\n配备LCD屏幕，操作简单。\n可以设置多次投食。\n在美国制造。\n\n有问题？请随时联系我们的客户服务团队，他们会解答您的所有问题。&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;&gt;product_name: 玻璃保护膜\ndescription: 规格:\n适用于各种尺寸的手机屏幕。\n\n为什么我们热爱它:\n我们的玻璃保护膜可以有效防止手机屏幕刮伤和破裂，而且不影响触控的灵敏度。\n\n材质与护理:\n使用干布擦拭。\n\n构造:\n由高强度的玻璃材料制成。\n\n其他特性:\n安装简单，适合自行安装。\n在日本制造。\n\n有问题？请随时联系我们的客户服务团队，他们会解答您的所有问题。&quot;
}
[llm/start] [1:chain:RetrievalQA &gt; 3:chain:StuffDocumentsChain &gt; 4:chain:LLMChain &gt; 5:llm:ChatOpenAI] Entering LLM run with input:
{
  &quot;prompts&quot;: [
    &quot;System: Use the following pieces of context to answer the users question. \nIf you don&#39;t know the answer, just say that you don&#39;t know, don&#39;t try to make up an answer.\n----------------\nproduct_name: 高清电视机\ndescription: 规格:\n尺寸：50&#39;&#39;。\n\n为什么我们热爱它:\n我们的高清电视机拥有出色的画质和强大的音效，带来沉浸式的观看体验。\n\n材质与护理:\n使用干布清洁。\n\n构造:\n由塑料、金属和电子元件制成。\n\n其他特性:\n支持网络连接，可以在线观看视频。\n配备遥控器。\n在韩国制造。\n\n有问题？请随时联系我们的客户服务团队，他们会解答您的所有问题。&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;&gt;product_name: 空气净化器\ndescription: 规格:\n尺寸：15&#39;&#39; x 15&#39;&#39; x 20&#39;&#39;。\n\n为什么我们热爱它:\n我们的空气净化器采用了先进的HEPA过滤技术，能有效去除空气中的微粒和异味，为您提供清新的室内环境。\n\n材质与护理:\n清洁时使用干布擦拭。\n\n构造:\n由塑料和电子元件制成。\n\n其他特性:\n三档风速，附带定时功能。\n在德国制造。\n\n有问题？请随时联系我们的客户服务团队，他们会解答您的所有问题。&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;&gt;product_name: 宠物自动喂食器\ndescription: 规格:\n尺寸：14&#39;&#39; x 9&#39;&#39; x 15&#39;&#39;。\n\n为什么我们热爱它:\n我们的宠物自动喂食器可以定时定量投放食物，让您无论在家或外出都能确保宠物的饮食。\n\n材质与护理:\n可用湿布清洁。\n\n构造:\n由塑料和电子元件制成。\n\n其他特性:\n配备LCD屏幕，操作简单。\n可以设置多次投食。\n在美国制造。\n\n有问题？请随时联系我们的客户服务团队，他们会解答您的所有问题。&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;&gt;product_name: 玻璃保护膜\ndescription: 规格:\n适用于各种尺寸的手机屏幕。\n\n为什么我们热爱它:\n我们的玻璃保护膜可以有效防止手机屏幕刮伤和破裂，而且不影响触控的灵敏度。\n\n材质与护理:\n使用干布擦拭。\n\n构造:\n由高强度的玻璃材料制成。\n\n其他特性:\n安装简单，适合自行安装。\n在日本制造。\n\n有问题？请随时联系我们的客户服务团队，他们会解答您的所有问题。\nHuman: 高清电视机怎么进行护理？&quot;
  ]
}
[llm/end] [1:chain:RetrievalQA &gt; 3:chain:StuffDocumentsChain &gt; 4:chain:LLMChain &gt; 5:llm:ChatOpenAI] [2.86s] Exiting LLM run with output:
{
  &quot;generations&quot;: [
    [
      {
        &quot;text&quot;: &quot;高清电视机的护理非常简单。您只需要使用干布清洁即可。避免使用湿布或化学清洁剂，以免损坏电视机的表面。&quot;,
        &quot;generation_info&quot;: {
          &quot;finish_reason&quot;: &quot;stop&quot;
        },
        &quot;message&quot;: {
          &quot;lc&quot;: 1,
          &quot;type&quot;: &quot;constructor&quot;,
          &quot;id&quot;: [
            &quot;langchain&quot;,
            &quot;schema&quot;,
            &quot;messages&quot;,
            &quot;AIMessage&quot;
          ],
          &quot;kwargs&quot;: {
            &quot;content&quot;: &quot;高清电视机的护理非常简单。您只需要使用干布清洁即可。避免使用湿布或化学清洁剂，以免损坏电视机的表面。&quot;,
            &quot;additional_kwargs&quot;: {}
          }
        }
      }
    ]
  ],
  &quot;llm_output&quot;: {
    &quot;token_usage&quot;: {
      &quot;prompt_tokens&quot;: 823,
      &quot;completion_tokens&quot;: 58,
      &quot;total_tokens&quot;: 881
    },
    &quot;model_name&quot;: &quot;gpt-3.5-turbo&quot;
  },
  &quot;run&quot;: null
}
[chain/end] [1:chain:RetrievalQA &gt; 3:chain:StuffDocumentsChain &gt; 4:chain:LLMChain] [2.86s] Exiting Chain run with output:
{
  &quot;text&quot;: &quot;高清电视机的护理非常简单。您只需要使用干布清洁即可。避免使用湿布或化学清洁剂，以免损坏电视机的表面。&quot;
}
[chain/end] [1:chain:RetrievalQA &gt; 3:chain:StuffDocumentsChain] [2.87s] Exiting Chain run with output:
{
  &quot;output_text&quot;: &quot;高清电视机的护理非常简单。您只需要使用干布清洁即可。避免使用湿布或化学清洁剂，以免损坏电视机的表面。&quot;
}
[chain/end] [1:chain:RetrievalQA] [3.26s] Exiting Chain run with output:
{
  &quot;result&quot;: &quot;高清电视机的护理非常简单。您只需要使用干布清洁即可。避免使用湿布或化学清洁剂，以免损坏电视机的表面。&quot;
}





&#39;高清电视机的护理非常简单。您只需要使用干布清洁即可。避免使用湿布或化学清洁剂，以免损坏电视机的表面。&#39;</code></pre>
<p>我们可以看到它首先深入到检索 QA
链中，然后它进入了一些文档链。如上所述，我们正在使用 stuff
方法，现在我们正在传递这个上下文，可以看到，这个上下文是由我们检索到的不同文档创建的。因此，在进行问答时，当返回错误结果时，通常不是语言模型本身出错了，实际上是检索步骤出错了，仔细查看问题的确切内容和上下文可以帮助调试出错的原因。</p>
<p>然后，我们可以再向下一级，看看进入语言模型的确切内容，以及 OpenAI
自身，在这里，我们可以看到传递的完整提示，我们有一个系统消息，有所使用的提示的描述，这是问题回答链使用的提示，我们可以看到提示打印出来，使用以下上下文片段回答用户的问题。</p>
<p>如果您不知道答案，只需说您不知道即可，不要试图编造答案。然后我们看到一堆之前插入的上下文，我们还可以看到有关实际返回类型的更多信息。我们不仅仅返回一个答案，还有
token 的使用情况，可以了解到 token 数的使用情况</p>
<p>由于这是一个相对简单的链，我们现在可以看到最终的响应，通过链返回给用户。这部分我们主要讲解了如何查看和调试单个输入到该链的情况。</p>
<h2 id="三-通过llm进行评估实例">三、 通过LLM进行评估实例</h2>
<p>来简要梳理一下问答评估的流程:</p>
<ul>
<li><p>首先，我们使用 LLM
自动构建了问答测试集，包含问题及标准答案。</p></li>
<li><p>然后，同一 LLM 试图回答测试集中的所有问题，得到响应。</p></li>
<li><p>下一步，需要评估语言模型的回答是否正确。这里奇妙的是，我们再使用另一个
LLM 链进行判断，所以 LLM 既是“球员”，又是“裁判”。</p></li>
</ul>
<p>具体来说，第一个语言模型负责回答问题。第二个语言模型链用来进行答案判定。最后我们可以收集判断结果，得到语言模型在这一任务上的效果分数。需要注意的是，回答问题的语言模型链和答案判断链是分开的，职责不同。这避免了同一个模型对自己结果的主观判断。</p>
<p>总之,语言模型可以自动完成构建测试集、回答问题和判定答案等全流程，使评估过程更加智能化和自动化。我们只需要提供文档并解析最终结果即可。</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>langchain.debug <span class="op">=</span> <span class="va">False</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">#为所有不同的示例创建预测</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> qa.<span class="bu">apply</span>(examples) </span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 对预测的结果进行评估，导入QA问题回答，评估链，通过语言模型创建此链</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.evaluation.qa <span class="im">import</span> QAEvalChain <span class="co">#导入QA问题回答，评估链</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co">#通过调用chatGPT进行评估</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>llm <span class="op">=</span> ChatOpenAI(temperature<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>eval_chain <span class="op">=</span> QAEvalChain.from_llm(llm)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co">#在此链上调用evaluate，进行评估</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>graded_outputs <span class="op">=</span> eval_chain.evaluate(examples, predictions)</span></code></pre></div>
<pre><code>&gt; Entering new RetrievalQA chain...

&gt; Finished chain.


&gt; Entering new RetrievalQA chain...

&gt; Finished chain.


&gt; Entering new RetrievalQA chain...

&gt; Finished chain.


&gt; Entering new RetrievalQA chain...

&gt; Finished chain.


&gt; Entering new RetrievalQA chain...

&gt; Finished chain.


&gt; Entering new RetrievalQA chain...

&gt; Finished chain.


&gt; Entering new RetrievalQA chain...

&gt; Finished chain.</code></pre>
<div class="sourceCode" id="cb20"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">#我们将传入示例和预测，得到一堆分级输出，循环遍历它们打印答案</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, eg <span class="kw">in</span> <span class="bu">enumerate</span>(examples):</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Example </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">:&quot;</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Question: &quot;</span> <span class="op">+</span> predictions[i][<span class="st">&#39;query&#39;</span>])</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Real Answer: &quot;</span> <span class="op">+</span> predictions[i][<span class="st">&#39;answer&#39;</span>])</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Predicted Answer: &quot;</span> <span class="op">+</span> predictions[i][<span class="st">&#39;result&#39;</span>])</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Predicted Grade: &quot;</span> <span class="op">+</span> graded_outputs[i][<span class="st">&#39;results&#39;</span>])</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span></code></pre></div>
<pre><code>Example 0:
Question: 高清电视机怎么进行护理？
Real Answer: 使用干布清洁。
Predicted Answer: 高清电视机的护理非常简单。您只需要使用干布清洁即可。避免使用湿布或化学清洁剂，以免损坏电视机的表面。
Predicted Grade: CORRECT

Example 1:
Question: 旅行背包有内外袋吗？
Real Answer: 有。
Predicted Answer: 是的，旅行背包有多个实用的内外袋，可以轻松装下您的必需品。
Predicted Grade: CORRECT

Example 2:
Question: 这款全自动咖啡机的尺寸是多少？
Real Answer: 大型尺寸为13.8&#39;&#39; x 17.3&#39;&#39;，中型尺寸为11.5&#39;&#39; x 15.2&#39;&#39;。
Predicted Answer: 这款全自动咖啡机有两种尺寸可选：
- 大型尺寸为13.8&#39;&#39; x 17.3&#39;&#39;。
- 中型尺寸为11.5&#39;&#39; x 15.2&#39;&#39;。
Predicted Grade: CORRECT

Example 3:
Question: 这款电动牙刷的规格是什么？
Real Answer: 一般大小 - 高度：9.5&#39;&#39;，宽度：1&#39;&#39;。
Predicted Answer: 这款电动牙刷的规格是：高度为9.5英寸，宽度为1英寸。
Predicted Grade: CORRECT

Example 4:
Question: 这种产品的名称是什么？
Real Answer: 这种产品的名称是橙味维生素C泡腾片。
Predicted Answer: 这种产品的名称是儿童益智玩具。
Predicted Grade: INCORRECT

Example 5:
Question: 这款无线蓝牙耳机的尺寸是多少？
Real Answer: 该无线蓝牙耳机的尺寸为1.5&#39;&#39; x 1.3&#39;&#39;。
Predicted Answer: 这款无线蓝牙耳机的尺寸是1.5&#39;&#39; x 1.3&#39;&#39;。
Predicted Grade: CORRECT

Example 6:
Question: 这款瑜伽垫的尺寸是多少？
Real Answer: 这款瑜伽垫的尺寸是24&#39;&#39; x 68&#39;&#39;。
Predicted Answer: 这款瑜伽垫的尺寸是24&#39;&#39; x 68&#39;&#39;。
Predicted Grade: CORRECT</code></pre>
<p>从上面的返回结果中我们可以看到，在评估结果中每一个问题中都包含了<code>Question</code>，<code>Real Answer</code>，<code>Predicted Answer</code>和<code>Predicted Grade</code>
四组内容，其中<code>Real Answer</code>是有先前的<code>QAGenerateChain</code>创建的问答测试集中的答案，而<code>Predicted Answer</code>则是由我们的<code>qa</code>链给出的答案，最后的<code>Predicted Grade</code>则是由上面代码中的<code>QAEvalChain</code>回答的。</p>
<p>在本章中，我们学习了使用 LangChain 框架实现 LLM
问答效果自动化评估的方法。与传统手工准备评估集、逐题判断等方式不同，LangChain
使整个评估流程自动化。它可以自动构建包含问答样本的测试集，然后使用语言模型对测试集自动产生回复，最后通过另一个模型链自动判断每个回答的准确性。<strong>这种全自动的评估方式极大地简化了问答系统的评估和优化过程，开发者无需手动准备测试用例，也无需逐一判断正确性，大大提升了工作效率</strong>。</p>
<p>借助LangChain的自动评估功能，我们可以快速评估语言模型在不同文档集上的问答效果，并可以持续地进行模型调优，无需人工干预。这种自动化的评估方法解放了双手，使我们可以更高效地迭代优化问答系统的性能。</p>
<p>总之，自动评估是 LangChain
框架的一大优势，它将极大地降低问答系统开发的门槛，使任何人都可以轻松训练出性能强大的问答模型。</p>
<h2 id="英文版提示">英文版提示</h2>
<p><strong>1. 创建LLM应用</strong></p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.chains <span class="im">import</span> RetrievalQA </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.chat_models <span class="im">import</span> ChatOpenAI </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.document_loaders <span class="im">import</span> CSVLoader </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.indexes <span class="im">import</span> VectorstoreIndexCreator </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.vectorstores <span class="im">import</span> DocArrayInMemorySearch </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.evaluation.qa <span class="im">import</span> QAGenerateChain </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="bu">file</span> <span class="op">=</span> <span class="st">&#39;../data/OutdoorClothingCatalog_1000.csv&#39;</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>loader <span class="op">=</span> CSVLoader(file_path<span class="op">=</span><span class="bu">file</span>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> loader.load()</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>test_data <span class="op">=</span> pd.read_csv(<span class="bu">file</span>,skiprows<span class="op">=</span><span class="dv">0</span>,usecols<span class="op">=</span>[<span class="dv">1</span>,<span class="dv">2</span>])</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>display(test_data.head())</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>llm <span class="op">=</span> ChatOpenAI(temperature <span class="op">=</span> <span class="fl">0.0</span>)</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>index <span class="op">=</span> VectorstoreIndexCreator(</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    vectorstore_cls<span class="op">=</span>DocArrayInMemorySearch</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>).from_loaders([loader])</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>qa <span class="op">=</span> RetrievalQA.from_chain_type(</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    llm<span class="op">=</span>llm, </span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>    chain_type<span class="op">=</span><span class="st">&quot;stuff&quot;</span>, </span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>    retriever<span class="op">=</span>index.vectorstore.as_retriever(), </span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    chain_type_kwargs <span class="op">=</span> {</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;document_separator&quot;</span>: <span class="st">&quot;&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;&gt;&quot;</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(data[<span class="dv">10</span>],<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(data[<span class="dv">11</span>],<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>examples <span class="op">=</span> [</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;query&quot;</span>: <span class="st">&quot;Do the Cozy Comfort Pullover Set have side pockets?&quot;</span>,</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Yes&quot;</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;query&quot;</span>: <span class="st">&quot;What collection is the Ultra-Lofty 850 Stretch Down Hooded Jacket from?&quot;</span>,</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;answer&quot;</span>: <span class="st">&quot;The DownTek collection&quot;</span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>example_gen_chain <span class="op">=</span> QAGenerateChain.from_llm(ChatOpenAI())</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.evaluation.qa <span class="im">import</span> QAGenerateChain <span class="co">#导入QA生成链，它将接收文档，并从每个文档中创建一个问题答案对</span></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>example_gen_chain <span class="op">=</span> QAGenerateChain.from_llm(ChatOpenAI())<span class="co">#通过传递chat open AI语言模型来创建这个链</span></span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>new_examples <span class="op">=</span> example_gen_chain.<span class="bu">apply</span>([{<span class="st">&quot;doc&quot;</span>: t} <span class="cf">for</span> t <span class="kw">in</span> data[:<span class="dv">5</span>]]) </span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a><span class="co">#查看用例数据</span></span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(new_examples) </span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>examples <span class="op">+=</span> [ v <span class="cf">for</span> item <span class="kw">in</span> new_examples <span class="cf">for</span> k,v <span class="kw">in</span> item.items()]</span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>qa.run(examples[<span class="dv">0</span>][<span class="st">&quot;query&quot;</span>])</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
name
</th>
<th>
description
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
Women’s Campside Oxfords
</td>
<td>
This ultracomfortable lace-to-toe Oxford boast…
</td>
</tr>
<tr>
<th>
1
</th>
<td>
Recycled Waterhog Dog Mat, Chevron Weave
</td>
<td>
Protect your floors from spills and splashing …
</td>
</tr>
<tr>
<th>
2
</th>
<td>
Infant and Toddler Girls’ Coastal Chill Swimsu…
</td>
<td>
She’ll love the bright colors, ruffles and exc…
</td>
</tr>
<tr>
<th>
3
</th>
<td>
Refresh Swimwear, V-Neck Tankini Contrasts
</td>
<td>
Whether you’re going for a swim or heading out…
</td>
</tr>
<tr>
<th>
4
</th>
<td>
EcoFlex 3L Storm Pants
</td>
<td>
Our new TEK O2 technology makes our four-seaso…
</td>
</tr>
</tbody>
</table>
</div>
<pre><code>page_content=&quot;: 10\nname: Cozy Comfort Pullover Set, Stripe\ndescription: Perfect for lounging, this striped knit set lives up to its name. We used ultrasoft fabric and an easy design that&#39;s as comfortable at bedtime as it is when we have to make a quick run out.\n\nSize &amp; Fit\n- Pants are Favorite Fit: Sits lower on the waist.\n- Relaxed Fit: Our most generous fit sits farthest from the body.\n\nFabric &amp; Care\n- In the softest blend of 63% polyester, 35% rayon and 2% spandex.\n\nAdditional Features\n- Relaxed fit top with raglan sleeves and rounded hem.\n- Pull-on pants have a wide elastic waistband and drawstring, side pockets and a modern slim leg.\n\nImported.&quot; metadata={&#39;source&#39;: &#39;../data/OutdoorClothingCatalog_1000.csv&#39;, &#39;row&#39;: 10} 

page_content=&#39;: 11\nname: Ultra-Lofty 850 Stretch Down Hooded Jacket\ndescription: This technical stretch down jacket from our DownTek collection is sure to keep you warm and comfortable with its full-stretch construction providing exceptional range of motion. With a slightly fitted style that falls at the hip and best with a midweight layer, this jacket is suitable for light activity up to 20° and moderate activity up to -30°. The soft and durable 100% polyester shell offers complete windproof protection and is insulated with warm, lofty goose down. Other features include welded baffles for a no-stitch construction and excellent stretch, an adjustable hood, an interior media port and mesh stash pocket and a hem drawcord. Machine wash and dry. Imported.&#39; metadata={&#39;source&#39;: &#39;../data/OutdoorClothingCatalog_1000.csv&#39;, &#39;row&#39;: 11} 

[{&#39;qa_pairs&#39;: {&#39;query&#39;: &quot;What is the description of the Women&#39;s Campside Oxfords?&quot;, &#39;answer&#39;: &quot;The description of the Women&#39;s Campside Oxfords is that they are an ultracomfortable lace-to-toe Oxford made of super-soft canvas. They have thick cushioning and quality construction, providing a broken-in feel from the first time they are worn.&quot;}}, {&#39;qa_pairs&#39;: {&#39;query&#39;: &#39;What are the dimensions of the small and medium sizes of the Recycled Waterhog Dog Mat, Chevron Weave?&#39;, &#39;answer&#39;: &#39;The dimensions of the small size of the Recycled Waterhog Dog Mat, Chevron Weave are 18&quot; x 28&quot;. The dimensions of the medium size are 22.5&quot; x 34.5&quot;.&#39;}}, {&#39;qa_pairs&#39;: {&#39;query&#39;: &quot;What are the features of the Infant and Toddler Girls&#39; Coastal Chill Swimsuit, Two-Piece?&quot;, &#39;answer&#39;: &quot;The swimsuit has bright colors, ruffles, and exclusive whimsical prints. It is made of four-way-stretch and chlorine-resistant fabric, which keeps its shape and resists snags. The fabric is UPF 50+ rated, providing the highest rated sun protection possible by blocking 98% of the sun&#39;s harmful rays. The swimsuit also has crossover no-slip straps and a fully lined bottom for a secure fit and maximum coverage.&quot;}}, {&#39;qa_pairs&#39;: {&#39;query&#39;: &#39;What is the fabric composition of the Refresh Swimwear, V-Neck Tankini Contrasts?&#39;, &#39;answer&#39;: &#39;The Refresh Swimwear, V-Neck Tankini Contrasts is made of 82% recycled nylon and 18% Lycra® spandex for the body, and 90% recycled nylon with 10% Lycra® spandex for the lining.&#39;}}, {&#39;qa_pairs&#39;: {&#39;query&#39;: &#39;What is the fabric composition of the EcoFlex 3L Storm Pants?&#39;, &#39;answer&#39;: &#39;The EcoFlex 3L Storm Pants are made of 100% nylon, exclusive of trim.&#39;}}]


&gt; Entering new RetrievalQA chain...

&gt; Finished chain.





&#39;Yes, the Cozy Comfort Pullover Set does have side pockets.&#39;</code></pre>
<p><strong>2. 人工评估</strong></p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> langchain</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>langchain.debug <span class="op">=</span> <span class="va">True</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co">#重新运行与上面相同的示例，可以看到它开始打印出更多的信息</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>qa.run(examples[<span class="dv">0</span>][<span class="st">&quot;query&quot;</span>])</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>langchain.debug <span class="op">=</span> <span class="va">False</span></span></code></pre></div>
<pre><code>[chain/start] [1:chain:RetrievalQA] Entering Chain run with input:
{
  &quot;query&quot;: &quot;Do the Cozy Comfort Pullover Set have side pockets?&quot;
}
[chain/start] [1:chain:RetrievalQA &gt; 3:chain:StuffDocumentsChain] Entering Chain run with input:
[inputs]
[chain/start] [1:chain:RetrievalQA &gt; 3:chain:StuffDocumentsChain &gt; 4:chain:LLMChain] Entering Chain run with input:
{
  &quot;question&quot;: &quot;Do the Cozy Comfort Pullover Set have side pockets?&quot;,
  &quot;context&quot;: &quot;: 10\nname: Cozy Comfort Pullover Set, Stripe\ndescription: Perfect for lounging, this striped knit set lives up to its name. We used ultrasoft fabric and an easy design that&#39;s as comfortable at bedtime as it is when we have to make a quick run out.\n\nSize &amp; Fit\n- Pants are Favorite Fit: Sits lower on the waist.\n- Relaxed Fit: Our most generous fit sits farthest from the body.\n\nFabric &amp; Care\n- In the softest blend of 63% polyester, 35% rayon and 2% spandex.\n\nAdditional Features\n- Relaxed fit top with raglan sleeves and rounded hem.\n- Pull-on pants have a wide elastic waistband and drawstring, side pockets and a modern slim leg.\n\nImported.&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;&gt;: 73\nname: Cozy Cuddles Knit Pullover Set\ndescription: Perfect for lounging, this knit set lives up to its name. We used ultrasoft fabric and an easy design that&#39;s as comfortable at bedtime as it is when we have to make a quick run out. \n\nSize &amp; Fit \nPants are Favorite Fit: Sits lower on the waist. \nRelaxed Fit: Our most generous fit sits farthest from the body. \n\nFabric &amp; Care \nIn the softest blend of 63% polyester, 35% rayon and 2% spandex.\n\nAdditional Features \nRelaxed fit top with raglan sleeves and rounded hem. \nPull-on pants have a wide elastic waistband and drawstring, side pockets and a modern slim leg. \nImported.&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;&gt;: 151\nname: Cozy Quilted Sweatshirt\ndescription: Our sweatshirt is an instant classic with its great quilted texture and versatile weight that easily transitions between seasons. With a traditional fit that is relaxed through the chest, sleeve, and waist, this pullover is lightweight enough to be worn most months of the year. The cotton blend fabric is super soft and comfortable, making it the perfect casual layer. To make dressing easy, this sweatshirt also features a snap placket and a heritage-inspired Mt. Katahdin logo patch. For care, machine wash and dry. Imported.&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;&gt;: 265\nname: Cozy Workout Vest\ndescription: For serious warmth that won&#39;t weigh you down, reach for this fleece-lined vest, which provides you with layering options whether you&#39;re inside or outdoors.\nSize &amp; Fit\nRelaxed Fit. Falls at hip.\nFabric &amp; Care\nSoft, textured fleece lining. Nylon shell. Machine wash and dry. \nAdditional Features \nTwo handwarmer pockets. Knit side panels stretch for a more flattering fit. Shell fabric is treated to resist water and stains. Imported.&quot;
}
[llm/start] [1:chain:RetrievalQA &gt; 3:chain:StuffDocumentsChain &gt; 4:chain:LLMChain &gt; 5:llm:ChatOpenAI] Entering LLM run with input:
{
  &quot;prompts&quot;: [
    &quot;System: Use the following pieces of context to answer the users question. \nIf you don&#39;t know the answer, just say that you don&#39;t know, don&#39;t try to make up an answer.\n----------------\n: 10\nname: Cozy Comfort Pullover Set, Stripe\ndescription: Perfect for lounging, this striped knit set lives up to its name. We used ultrasoft fabric and an easy design that&#39;s as comfortable at bedtime as it is when we have to make a quick run out.\n\nSize &amp; Fit\n- Pants are Favorite Fit: Sits lower on the waist.\n- Relaxed Fit: Our most generous fit sits farthest from the body.\n\nFabric &amp; Care\n- In the softest blend of 63% polyester, 35% rayon and 2% spandex.\n\nAdditional Features\n- Relaxed fit top with raglan sleeves and rounded hem.\n- Pull-on pants have a wide elastic waistband and drawstring, side pockets and a modern slim leg.\n\nImported.&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;&gt;: 73\nname: Cozy Cuddles Knit Pullover Set\ndescription: Perfect for lounging, this knit set lives up to its name. We used ultrasoft fabric and an easy design that&#39;s as comfortable at bedtime as it is when we have to make a quick run out. \n\nSize &amp; Fit \nPants are Favorite Fit: Sits lower on the waist. \nRelaxed Fit: Our most generous fit sits farthest from the body. \n\nFabric &amp; Care \nIn the softest blend of 63% polyester, 35% rayon and 2% spandex.\n\nAdditional Features \nRelaxed fit top with raglan sleeves and rounded hem. \nPull-on pants have a wide elastic waistband and drawstring, side pockets and a modern slim leg. \nImported.&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;&gt;: 151\nname: Cozy Quilted Sweatshirt\ndescription: Our sweatshirt is an instant classic with its great quilted texture and versatile weight that easily transitions between seasons. With a traditional fit that is relaxed through the chest, sleeve, and waist, this pullover is lightweight enough to be worn most months of the year. The cotton blend fabric is super soft and comfortable, making it the perfect casual layer. To make dressing easy, this sweatshirt also features a snap placket and a heritage-inspired Mt. Katahdin logo patch. For care, machine wash and dry. Imported.&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;&gt;: 265\nname: Cozy Workout Vest\ndescription: For serious warmth that won&#39;t weigh you down, reach for this fleece-lined vest, which provides you with layering options whether you&#39;re inside or outdoors.\nSize &amp; Fit\nRelaxed Fit. Falls at hip.\nFabric &amp; Care\nSoft, textured fleece lining. Nylon shell. Machine wash and dry. \nAdditional Features \nTwo handwarmer pockets. Knit side panels stretch for a more flattering fit. Shell fabric is treated to resist water and stains. Imported.\nHuman: Do the Cozy Comfort Pullover Set have side pockets?&quot;
  ]
}
[llm/end] [1:chain:RetrievalQA &gt; 3:chain:StuffDocumentsChain &gt; 4:chain:LLMChain &gt; 5:llm:ChatOpenAI] [879.746ms] Exiting LLM run with output:
{
  &quot;generations&quot;: [
    [
      {
        &quot;text&quot;: &quot;Yes, the Cozy Comfort Pullover Set does have side pockets.&quot;,
        &quot;generation_info&quot;: {
          &quot;finish_reason&quot;: &quot;stop&quot;
        },
        &quot;message&quot;: {
          &quot;lc&quot;: 1,
          &quot;type&quot;: &quot;constructor&quot;,
          &quot;id&quot;: [
            &quot;langchain&quot;,
            &quot;schema&quot;,
            &quot;messages&quot;,
            &quot;AIMessage&quot;
          ],
          &quot;kwargs&quot;: {
            &quot;content&quot;: &quot;Yes, the Cozy Comfort Pullover Set does have side pockets.&quot;,
            &quot;additional_kwargs&quot;: {}
          }
        }
      }
    ]
  ],
  &quot;llm_output&quot;: {
    &quot;token_usage&quot;: {
      &quot;prompt_tokens&quot;: 626,
      &quot;completion_tokens&quot;: 14,
      &quot;total_tokens&quot;: 640
    },
    &quot;model_name&quot;: &quot;gpt-3.5-turbo&quot;
  },
  &quot;run&quot;: null
}
[chain/end] [1:chain:RetrievalQA &gt; 3:chain:StuffDocumentsChain &gt; 4:chain:LLMChain] [880.5269999999999ms] Exiting Chain run with output:
{
  &quot;text&quot;: &quot;Yes, the Cozy Comfort Pullover Set does have side pockets.&quot;
}
[chain/end] [1:chain:RetrievalQA &gt; 3:chain:StuffDocumentsChain] [881.4499999999999ms] Exiting Chain run with output:
{
  &quot;output_text&quot;: &quot;Yes, the Cozy Comfort Pullover Set does have side pockets.&quot;
}
[chain/end] [1:chain:RetrievalQA] [1.21s] Exiting Chain run with output:
{
  &quot;result&quot;: &quot;Yes, the Cozy Comfort Pullover Set does have side pockets.&quot;
}</code></pre>
<p><strong>3. 通过LLM进行评估实例</strong></p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>langchain.debug <span class="op">=</span> <span class="va">False</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co">#为所有不同的示例创建预测</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> qa.<span class="bu">apply</span>(examples) </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 对预测的结果进行评估，导入QA问题回答，评估链，通过语言模型创建此链</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.evaluation.qa <span class="im">import</span> QAEvalChain <span class="co">#导入QA问题回答，评估链</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="co">#通过调用chatGPT进行评估</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>llm <span class="op">=</span> ChatOpenAI(temperature<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>eval_chain <span class="op">=</span> QAEvalChain.from_llm(llm)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="co">#在此链上调用evaluate，进行评估</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>graded_outputs <span class="op">=</span> eval_chain.evaluate(examples, predictions)</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="co">#我们将传入示例和预测，得到一堆分级输出，循环遍历它们打印答案</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, eg <span class="kw">in</span> <span class="bu">enumerate</span>(examples):</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Example </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">:&quot;</span>)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Question: &quot;</span> <span class="op">+</span> predictions[i][<span class="st">&#39;query&#39;</span>])</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Real Answer: &quot;</span> <span class="op">+</span> predictions[i][<span class="st">&#39;answer&#39;</span>])</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Predicted Answer: &quot;</span> <span class="op">+</span> predictions[i][<span class="st">&#39;result&#39;</span>])</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Predicted Grade: &quot;</span> <span class="op">+</span> graded_outputs[i][<span class="st">&#39;results&#39;</span>])</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span></code></pre></div>
<pre><code>&gt; Entering new RetrievalQA chain...

&gt; Finished chain.


&gt; Entering new RetrievalQA chain...

&gt; Finished chain.


&gt; Entering new RetrievalQA chain...

&gt; Finished chain.


&gt; Entering new RetrievalQA chain...

&gt; Finished chain.


&gt; Entering new RetrievalQA chain...

&gt; Finished chain.


&gt; Entering new RetrievalQA chain...

&gt; Finished chain.


&gt; Entering new RetrievalQA chain...

&gt; Finished chain.
Example 0:
Question: Do the Cozy Comfort Pullover Set have side pockets?
Real Answer: Yes
Predicted Answer: Yes, the Cozy Comfort Pullover Set does have side pockets.
Predicted Grade: CORRECT

Example 1:
Question: What collection is the Ultra-Lofty 850 Stretch Down Hooded Jacket from?
Real Answer: The DownTek collection
Predicted Answer: The Ultra-Lofty 850 Stretch Down Hooded Jacket is from the DownTek collection.
Predicted Grade: CORRECT

Example 2:
Question: What is the description of the Women&#39;s Campside Oxfords?
Real Answer: The description of the Women&#39;s Campside Oxfords is that they are an ultracomfortable lace-to-toe Oxford made of super-soft canvas. They have thick cushioning and quality construction, providing a broken-in feel from the first time they are worn.
Predicted Answer: The description of the Women&#39;s Campside Oxfords is: &quot;This ultracomfortable lace-to-toe Oxford boasts a super-soft canvas, thick cushioning, and quality construction for a broken-in feel from the first time you put them on.&quot;
Predicted Grade: CORRECT

Example 3:
Question: What are the dimensions of the small and medium sizes of the Recycled Waterhog Dog Mat, Chevron Weave?
Real Answer: The dimensions of the small size of the Recycled Waterhog Dog Mat, Chevron Weave are 18&quot; x 28&quot;. The dimensions of the medium size are 22.5&quot; x 34.5&quot;.
Predicted Answer: The dimensions of the small size of the Recycled Waterhog Dog Mat, Chevron Weave are 18&quot; x 28&quot;. The dimensions of the medium size are 22.5&quot; x 34.5&quot;.
Predicted Grade: CORRECT

Example 4:
Question: What are the features of the Infant and Toddler Girls&#39; Coastal Chill Swimsuit, Two-Piece?
Real Answer: The swimsuit has bright colors, ruffles, and exclusive whimsical prints. It is made of four-way-stretch and chlorine-resistant fabric, which keeps its shape and resists snags. The fabric is UPF 50+ rated, providing the highest rated sun protection possible by blocking 98% of the sun&#39;s harmful rays. The swimsuit also has crossover no-slip straps and a fully lined bottom for a secure fit and maximum coverage.
Predicted Answer: The features of the Infant and Toddler Girls&#39; Coastal Chill Swimsuit, Two-Piece are:

- Bright colors and ruffles
- Exclusive whimsical prints
- Four-way-stretch and chlorine-resistant fabric
- UPF 50+ rated fabric for sun protection
- Crossover no-slip straps
- Fully lined bottom for a secure fit and maximum coverage
- Machine washable and line dry for best results
- Imported
Predicted Grade: CORRECT

Example 5:
Question: What is the fabric composition of the Refresh Swimwear, V-Neck Tankini Contrasts?
Real Answer: The Refresh Swimwear, V-Neck Tankini Contrasts is made of 82% recycled nylon and 18% Lycra® spandex for the body, and 90% recycled nylon with 10% Lycra® spandex for the lining.
Predicted Answer: The fabric composition of the Refresh Swimwear, V-Neck Tankini Contrasts is 82% recycled nylon with 18% Lycra® spandex for the body, and 90% recycled nylon with 10% Lycra® spandex for the lining.
Predicted Grade: CORRECT

Example 6:
Question: What is the fabric composition of the EcoFlex 3L Storm Pants?
Real Answer: The EcoFlex 3L Storm Pants are made of 100% nylon, exclusive of trim.
Predicted Answer: The fabric composition of the EcoFlex 3L Storm Pants is 100% nylon, exclusive of trim.
Predicted Grade: CORRECT</code></pre>
</body>
</html>
